# Promtail Configuration for Spontra Platform

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # System logs
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: varlogs
          __path__: /var/log/*log

  # Docker container logs
  - job_name: containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: containerlogs
          __path__: /var/lib/docker/containers/*/*log
    
    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
            attrs: attrs
      - json:
          expressions:
            tag: attrs.tag
          source: attrs
      - regex:
          expression: (?P<container_name>(?:[^|]*))\|
          source: tag
      - timestamp:
          format: RFC3339Nano
          source: time
      - labels:
          stream:
          container_name:
      - output:
          source: output

  # Application logs (if services write to files)
  - job_name: spontra-apps
    static_configs:
      - targets:
          - localhost
        labels:
          job: spontra-apps
          __path__: /var/log/spontra/*log
    
    pipeline_stages:
      - match:
          selector: '{job="spontra-apps"}'
          stages:
            - regex:
                expression: '\[(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}[^\]]*)\]\s+(?P<level>\w+)\s+(?P<service>\w+)\s+(?P<message>.*)'
            - timestamp:
                format: RFC3339
                source: timestamp
            - labels:
                level:
                service:

  # User Service logs
  - job_name: user-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: user-service
          service: user-service
          __path__: /var/log/spontra/user-service*log

  # Search Service logs
  - job_name: search-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: search-service
          service: search-service
          __path__: /var/log/spontra/search-service*log

  # Pricing Service logs
  - job_name: pricing-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: pricing-service
          service: pricing-service
          __path__: /var/log/spontra/pricing-service*log

  # Data Ingestion Service logs
  - job_name: data-ingestion-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: data-ingestion-service
          service: data-ingestion-service
          __path__: /var/log/spontra/data-ingestion-service*log

  # Nginx access logs (if using nginx)
  - job_name: nginx
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          __path__: /var/log/nginx/*log
    
    pipeline_stages:
      - match:
          selector: '{job="nginx"}'
          stages:
            - regex:
                expression: '^(?P<remote_addr>[\w\.]+) - (?P<remote_user>\S+) \[(?P<time_local>[\w:/]+\s[+\-]\d{4})\] "(?P<method>\S+) (?P<request>\S+) (?P<protocol>\S+)" (?P<status>\d+) (?P<body_bytes_sent>\d+) "(?P<http_referer>[^"]*)" "(?P<http_user_agent>[^"]*)"'
            - timestamp:
                format: 02/Jan/2006:15:04:05 -0700
                source: time_local
            - labels:
                method:
                status:

  # PostgreSQL logs
  - job_name: postgresql
    static_configs:
      - targets:
          - localhost
        labels:
          job: postgresql
          __path__: /var/log/postgresql/*log

  # Redis logs
  - job_name: redis
    static_configs:
      - targets:
          - localhost
        labels:
          job: redis
          __path__: /var/log/redis/*log